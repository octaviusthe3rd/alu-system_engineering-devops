#!/usr/bin/env bash
# Script to setup a Docker container and execute it as required

IMAGE_NAME="holbertonschool/265-0"
CONTAINER_PORT=80
HOST_PORT=8080

# Setting up the environment
echo "Updating system and installing dependencies..."
sudo apt update && sudo apt upgrade -y
mkdir -p DockerSetup && cd DockerSetup


# Installing Snap and Docker
sudo apt install snapd
sudo snap install docker
sudo apt update

# Creating the Dockerfile
echo "Creating Dockerfile..."
cat <<EOF > Dockerfile
FROM ubuntu:16.04
ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update && apt-get install -y apache2
RUN apt-get clean && rm -rf /var/lib/apt/lists/*
WORKDIR /var/www/html
RUN echo "Hello Holberton" > index.html
EXPOSE 80
CMD ["apachectl", "-D", "FOREGROUND"]
EOF

if [ $? -ne 0 ]; then
    echo "Error: Failed to create Dockerfile."
    exit 1
fi
echo "Dockerfile created successfully."

# Building the Docker image
echo "Building Docker image..."
docker build -t $IMAGE_NAME .
if [ $? -ne 0 ]; then
    echo "Error: Failed to build the Docker image."
    exit 1
fi
echo "Docker image built successfully: $IMAGE_NAME"

# Running the container
echo "Running Docker container..."
docker run -p $HOST_PORT:$CONTAINER_PORT -d $IMAGE_NAME
if [ $? -ne 0 ]; then
    echo "Error: Failed to run the Docker container."
    exit 1
fi

# Using the curl command to test the response
echo "Testing container response..."
sleep 2
RESPONSE=$(curl -s http://localhost:$HOST_PORT)
if [[ "$RESPONSE" == "Hello Holberton" ]]; then
    echo "Container is working as expected! Returned response:$RESPONSE"
else
    echo "Error: Expected 'Hello Holberton', but got: $RESPONSE"
    exit 1
fi
